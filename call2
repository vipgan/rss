import os
import asyncio
import html
from datetime import datetime
import pytz
import requests
from dotenv import load_dotenv
from lunarcalendar import Converter, Solar, Lunar

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# é…ç½®å‚æ•°
TOKEN = os.getenv('TELEGRAM_API_KEY')
CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')

# è®¾ç½®é¦™æ¸¯æ—¶åŒº
hong_kong = pytz.timezone('Asia/Hong_Kong')
BASE_DATE = datetime(2024, 12, 6, tzinfo=hong_kong)

def send_telegram_message(plain_text, html_text):
    """åŒæ¨¡å¼æ¶ˆæ¯å‘é€"""
    try:
        response = requests.post(
            f'https://api.telegram.org/bot{TOKEN}/sendMessage',
            data={
                'chat_id': CHAT_ID,
                'text': html_text,
                'parse_mode': 'HTML'
            }
        )
        response.raise_for_status()
    except requests.exceptions.RequestException:
        try:
            requests.post(
                f'https://api.telegram.org/bot{TOKEN}/sendMessage',
                data={'chat_id': CHAT_ID, 'text': plain_text}
            )
        except Exception as e:
            print(f"å…¨éƒ¨å‘é€æ–¹å¼å¤±è´¥: {e}")

async def check_reminders():
    now = datetime.now(hong_kong)
    current_date = now.strftime("%Yå¹´%mæœˆ%dæ—¥")
    
    # åˆå§‹åŒ–æ¶ˆæ¯åˆ—è¡¨
    messages = [f"ğŸ“… æ¸©é¦¨æé†’ï¼šä»Šå¤©æ˜¯{current_date}ï¼Œè¯·ç•™æ„ä»¥ä¸‹äº‹é¡¹ï¼š"]

    # ================= æ—¥å¸¸æé†’ =================
    # æ¯æ—¥å®šæ—¶æé†’ (08:00)
    if now.hour == 8 and now.minute == 0:
        messages.append("ğŸ•— æ—¶é—´åˆ°ï¼Œè®°å¾—åƒè¯ï¼")

    # ================= å‘¨æœŸæ€§æé†’ =================
    # æ¯10å¤©é€šè¡Œè¯ç»­ç­¾
    if (now - BASE_DATE).days % 10 == 0:
        messages.append("ğŸ”„ ç»­ç­¾é€šè¡Œè¯ï¼")

    # ================= å›ºå®šæ—¥æœŸå¹´æé†’ =================
    annual_reminders = {
        (3, 1): "ğŸš— å°æ±½è½¦æ‰“è…Šä¿å…»",
        (5, 1): "ğŸ“ ä»ä¸šèµ„æ ¼è¯å¹´å®¡åˆ°æœŸ",
        (10, 5): "ğŸ’ ç»“å©šå‘¨å¹´çºªå¿µæ—¥",
        (11, 26): "âœˆï¸ å½­æ˜Šä¸€ç¦»æ¸¯çºªå¿µæ—¥",
        (12, 1): "ğŸ“‹ å°è½¦å¹´æ£€ä¿é™©åˆ°æœŸ"
    }
    if (now.month, now.day) in annual_reminders:
        messages.append(annual_reminders[(now.month, now.day)])

    # ================= ç‰¹å®šå¹´ä»½æé†’ =================
    specific_year_reminders = {
        (2025, 4, 5): "ğŸ¦ æ¢é¢†å»ºè¡Œé“¶è¡Œå¡",
        (2026, 10, 5): "ğŸ’ ç»“å©š20å‘¨å¹´çºªå¿µ",
        (2027, 5, 1): "ğŸ¥ å½­è´å¨œåŒ»ä¿å¡æ¢å¡",
        (2027, 5, 11): "ğŸ†” å½­ä»˜ç”Ÿèº«ä»½è¯æ¢è¯",
        (2028, 6, 1): "ğŸ’³ æ‹›å•†é“¶è¡Œå¡åˆ°æœŸ",
        (2037, 3, 22): "ğŸ†” æœ¬äººèº«ä»½è¯æ¢è¯"
    }
    if (now.year, now.month, now.day) in specific_year_reminders:
        messages.append(specific_year_reminders[(now.year, now.month, now.day)])

    # ================= æ¯æœˆå›ºå®šæé†’ =================
    if now.day == 1:
        messages.append("ğŸ“¸ æ¯æœˆæé†’ï¼šäº‘é—ªä»˜æ±½è½¦æ‹ç…§")

    # ================= å†œå†æé†’ =================
    lunar_date = Converter.Solar2Lunar(Solar(now.year, now.month, now.day))
    lunar_birthdays = {
        (2, 1): "ğŸ‚ æœæ ¹å å†œå†ç”Ÿæ—¥",
        (2, 28): "ğŸ‚ å½­ä½³æ–‡ å†œå†ç”Ÿæ—¥",
        (3, 11): "ğŸ‚ åˆ˜è£•è å†œå†ç”Ÿæ—¥",
        (4, 12): "ğŸ‚ å½­ç»è² å†œå†ç”Ÿæ—¥",
        (4, 20): "ğŸ‚ é‚¬æ€ å†œå†ç”Ÿæ—¥",
        (4, 27): "ğŸ‚ å½­åš å†œå†ç”Ÿæ—¥",
        (5, 5): "ğŸ‚ å‘¨å­å› å†œå†ç”Ÿæ—¥",
        (5, 17): "ğŸ‚ æœä¿Šè±ª å†œå†ç”Ÿæ—¥",
        (8, 17): "ğŸ‚ é‚¬å¯å…ƒ å†œå†ç”Ÿæ—¥",
        (8, 19): "ğŸ‚ å¥¶å¥¶ å†œå†ç”Ÿæ—¥",
        (10, 9): "ğŸ‚ å½­ä»˜ç”Ÿ å†œå†ç”Ÿæ—¥",
        (10, 18): "ğŸ‚ å½­è´å¨œ å†œå†ç”Ÿæ—¥",
        (11, 12): "ğŸ‚ å½­è¾‰ å†œå†ç”Ÿæ—¥",
        (11, 22): "ğŸ‚ å½­å¹² å†œå†ç”Ÿæ—¥",
        (12, 1): "ğŸ‚ å½­æ˜Šä¸€ å†œå†ç”Ÿæ—¥",
        (12, 29): "ğŸ‚ å½­ä¸–åº† å†œå†ç”Ÿæ—¥"
    }
    if (lunar_date.month, lunar_date.day) in lunar_birthdays:
        messages.append(lunar_birthdays[(lunar_date.month, lunar_date.day)])

    # ================= æ¶ˆæ¯å‘é€ =================
    if len(messages) > 1:
        # æ„é€ æ¶ˆæ¯å†…å®¹
        plain = '\n\n'.join(messages)
        
        # HTMLæ ¼å¼å¤„ç†
        escaped = []
        for msg in messages:
            # é¦–è¡Œä¸åŠ ç²—ï¼Œå…¶ä»–è¡ŒåŠ ç²—
            if msg.startswith("ğŸ“…"):
                escaped.append(html.escape(msg))
            else:
                escaped.append(f"<b>{html.escape(msg)}</b>")
        
        html_content = "<br/><br/>".join(escaped)
        send_telegram_message(plain, html_content)

if __name__ == "__main__":
    asyncio.run(check_reminders())